platform :ios, '15.0'

use_modular_headers!

install! 'cocoapods',
         :deterministic_uuids => false,
         :warn_for_unused_master_specs_repo => false

workspace 'CLDemo.xcworkspace'

# ========= 公共 Pods =========
def common_pods
  pod 'SDWebImage'
  pod 'DateTools'
end

# ========= OC Target =========
target 'CLDemo-OC' do
  project 'CLDemo-OC/CLDemo-OC.xcodeproj'

  common_pods

  pod 'Masonry'
  pod 'MJExtension'
  pod 'SDWebImageWebPCoder'
end

# ========= Swift Target =========
target 'CLDemo-Swift' do
  project 'CLDemo-Swift/CLDemo-Swift.xcodeproj'

  common_pods

  pod 'SnapKit'
  pod 'lottie-ios'
  pod 'DateToolsSwift'
  pod 'SwiftyJSON'
  pod 'CryptoSwift'
  pod 'Kingfisher'
  pod 'TZImagePickerController'
  pod 'LookinServer', :configurations => ['Debug']
  pod 'CocoaLumberjack/Swift'
  pod 'CLTableViewManager'
  pod 'CLNestedSlide'

  # 本地 / 私有组件
  pod 'CLCamera', :git => 'https://github.com/JmoVxia/CLCamera.git'
  pod 'CLPopoverManager', :git => 'https://github.com/JmoVxia/CLPopoverManager.git'

  # 工具类，不进 App
  pod 'SwiftFormat/CLI', :configurations => ['Debug']
end

# ========= Post Install =========
post_install do |installer|
  installer.pods_project.targets.each do |target|
    target.build_configurations.each do |config|
      # 统一最低系统版本
      config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '15.0'

      # 强制 Pods 使用 Swift 5，避免 Swift 6 兼容问题
      config.build_settings['SWIFT_VERSION'] = '5.0'

      # 禁用所有警告
      config.build_settings['CLANG_WARN_DEPRECATED_DECLARATIONS'] = 'NO'
      config.build_settings['GCC_WARN_INHIBIT_ALL_WARNINGS'] = 'YES'
      swift_flags = config.build_settings['OTHER_SWIFT_FLAGS'] || '$(inherited)'
      config.build_settings['OTHER_SWIFT_FLAGS'] = "#{swift_flags} -suppress-warnings"
    end

    # Kingfisher 的 ABI / Distribution 警告
    if target.name == 'Kingfisher'
      target.build_configurations.each do |config|
        config.build_settings['BUILD_LIBRARY_FOR_DISTRIBUTION'] = 'NO'
      end
    end

    # CocoaLumberjack 需要启用实验性功能
    if target.name == 'CocoaLumberjack'
      target.build_configurations.each do |config|
        swift_flags = config.build_settings['OTHER_SWIFT_FLAGS'] || '$(inherited)'
        config.build_settings['OTHER_SWIFT_FLAGS'] = "#{swift_flags} -Xfrontend -enable-experimental-feature -Xfrontend AccessLevelOnImport"
      end
    end
  end
end
